<script src="../webcomponentsjs/webcomponents.min.js"></script>
<link rel="import" href="../polymer/polymer.html" />

<dom-module id="gfs-selected-droppoint">

	<template>
		<style>
			div, span {
				font-family: "Raleway", "Helvetica Neue", Verdana, Arial, sans-serif;
			}

			h3 {
				margin-top: 0px;
			}

			ul {
				padding-left: 2px;
			}

			li {
				display: block;
			}

			tr {
				line-height: 0.6em;
			}

			.content-container {
				margin: auto;
				width: 100%;
			}

			.overlay {
				margin: auto;
				width: 100%;
			}

				.overlay .special-badges {
					float: none;
				}

			.content-container-cols {
				display: flex;
				margin: auto;
				width: 100%;
			}

			.no-button button {
				display: none;
			}

			.no-button.dp-card .actions {
				display: none;
			}

			.no-button.dp-card {
				/*height: 208px;*/
			}

			.dp-card {
				padding: 10px;
				margin: 10px;
				background-color: #FAFAFA;
				border-radius: 3px;
				box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
				border: 1px solid #FAFAFA;
			}

			.dp-mini-card {
				padding: 10px;
				margin: 10px;
				width: 200px;
				background-color: #FAFAFA;
				border-radius: 3px;
				box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
				border: 1px solid #FAFAFA;
			}


			.dp-card .content {
				display: flex;
			}

				.dp-card .content .dp-details {
					width: 66%;
					overflow: hidden;
				}

			.dp-heading {
				margin-top: 4px;
				margin-bottom: 4px;
			}

			.dp-small-heading {
				margin-top: 8px;
				margin-bottom: 0px;
				font-size: 0.6em;
			}

			.label {
				color: white;
				font-weight: bold;
			}

			.dp-content {
				width: 100%;
			}

			.dp-address {
				text-align: left;
			}

			.open-late {
				font-size: 0.5em;
				padding: 4px;
			}

			#dp-distance {
				margin-bottom: 0px;
			}

				#dp-distance .fa {
					margin-right: 0.2em;
				}

			.choose-droppoint {
				background-color: #555555;
				border: none;
				color: white;
				margin-top: 15px;
				padding: 8px 20px;
				text-align: center;
				text-decoration: none;
				font-size: 16px;
				float: right;
			}

				.choose-droppoint.chosen {
					background-color: #4CAF50; /* Green */
				}

			.dp-opening-hours table {
				margin-top: 6px;
			}

			div.dp-day-name {
				font-weight: bold;
			}

			.special-badges {
				margin: 5px 0 0;
				display: flex;
				float: right;
			}

			.open-late {
				background-image: url('/bower_components/gfs-selected-droppoint/opensign.png');
				background-repeat: no-repeat;
				background-size: 26px 26px;
				width: 32px;
			}

			.parking {
				background-image: url('/bower_components/gfs-selected-droppoint/parking.png');
				background-repeat: no-repeat;
				background-size: 32px 32px;
				width: 32px;
			}

			.open-late .badge-text {
				margin-top: 22px;
				font-weight: bold;
			}

			.overlay .open-late {
				-webkit-filter: invert(1);
				filter: invert(1);
			}


			/* MP customization */
			.dp-card {
				min-height: 245px;
				margin: 0 0 20px 0;
				overflow: hidden;
			}

				.dp-card:nth-child(2n+1) {
					margin-right: 0;
				}

				.dp-card .content .dp-details {
					width: 45%;
					margin: 0 10px 0 0;
				}

			/* opening hours table style */
			.dp-day-name, .dp-day-time-slot {
				font-size: 13px;
			}

			.dp-small-heading {
				margin-bottom: 0;
				font-size: 13px;
				font-weight: bold;
			}

			.dp-icon {
				margin: 0 0 5px;
			}

			.dp-address, .dp-distance {
				font-size: 13px;
			}

			/* clear floats */
			.clear-fl {
				clear: both;
			}


			@media (max-width: 976px) {
				.dp-card {
					min-width: 350px;
					width: 100%;
					margin: 10px 0;
					display: block;
				}

					.dp-card .content {
						display: block;
					}

				.dp-details {
					float: left;
				}

				.dp-opening-hours {
					float: right;
				}

				.dp-card-margin {
					margin-right: 20px;
				}

				.dp-card .content .dp-details {
					width: 120px;
				}

				.actions {
					clear: both;
				}
			}

			@media (max-width: 340px) {
				.dp-card {
					min-width: 250px;
					margin: 10px 0;
					display: block;
				}

				.dp-details {
					float: left;
				}

				.dp-opening-hours {
					float: right;
				}

				.dp-card-margin {
					margin-right: 10px;
				}

				.dp-card .content .dp-details {
					width: 80px;
					/*margin-right: 18px;*/
				}

				#dp-address, #dp-distance, .dp-small-heading,
				.dp-day-name, .dp-day-time-slot {
					font-size: 11px;
				}
			}
		</style>

		<template is="dom-if" is="dom-if" if="{{_visible}}">
			<div class$="{{containerClass}}">
				<template is="dom-if" if="{{title}}">
					<h3>{{title}}</h3>
				</template>

				<div class="content">

					<div class="dp-details">

						<div class="dp-icon">
							<img src="{{droppointData.providerLogo}}" class="imageicon" height="45" />
						</div>
						<div id="dp-address">
							<template is="dom-repeat" items="{{droppointData.geoLocation.addressLines}}">
								{{item}}
								<br />
							</template>

							{{droppointData.geoLocation.town}}, {{droppointData.geoLocation.postCode}}

						</div>
						<template is="dom-if" if="showDistance">
							<div class="dp-small-heading">Distance</div>
							<div id="dp-distance">
								<i class="fa fa-road"></i>{{droppointData.localizedDistance}}
							</div>
						</template>

					</div>


					<template is="dom-if" if="{{showOpeningHours}}">

						<div class="dp-opening-hours">
							<div class="dp-small-heading">Opening Hours</div>
							<table>
								<template is="dom-repeat" items="{{droppointData.weekCollectionSlots}}">
									<tr>
										<td class="dp-day-name"><ul><li>{{item.day}}</li></ul></td>
										<td class="dp-day-time-slots">
											<ul>
												<template is="dom-repeat" items={{item.timeSlots}}>
													<li class="dp-day-time-slot">{{item.fromTime}} - {{item.toTime}}</li>
												</template>
											</ul>
										</td>
									</tr>
								</template>
							</table>

							<div class="special-badges">
								<div class="open-late">
									<div class="badge-text">LATE</div>
								</div>
								<div class="open-late">
									<div class="badge-text">SAT</div>
								</div>
								<div class="open-late">
									<div class="badge-text">SUN</div>
								</div>
								<div class="parking"></div>
							</div>
						</div>
					</template>
				</div>
				<!--<div class="actions">
					<template is="dom-if" if="{{isTickButton}}">
						<div class$="b-tick {{buttonClass}}" on-click="toggleChooseDropPoint"></div>
					</template>
					<template is="dom-if" if="{{isStandardButton}}">
						<button on-click="toggleChooseDropPoint" class$="button choose-droppoint {{buttonClass}}">{{buttonText}}</button>
					</template>
				</div>-->
			</div>
		</template>
	</template>

	<script>

		Polymer({
			is: "gfs-selected-droppoint",

			properties: {
				title: {
					type: String
				},

				droppointData: {
					type: Object,
					value: {}
				},
				buttonType: {
					type: String,
					value: "standard"
				},
				showOpeningHours: {
					type: Object,
					value: false
				},
				showDistance: {
					type: Object,
					value: true
				},
				containerClass: {
					type: String,
					value: "content-container"
				},
				droppointId: {
					type: String
				},
				buttonClass: {
					type: String,
					value: "unchosen"
				},
				buttonText: {
					type: String,
					value: "Choose"
				},
				streetAddress: {
					type: String,
					notify: true
				},
				_visible: {
					type: Boolean,
					value: false
				},
				_computeVisible: {
					type: Boolean,
					computed: 'computeVisible(droppointData)'
				}
			},

			computeVisible: function(droppointData)
			{
				console.log('computeVisible' + droppointData);
				return (droppointData.chosen);
			},

			ready: function () {

				var self = this;
				this.initData();
				window.addEventListener('droppoint-changed', this.onDroppointChanged.bind(this), false);

			},

			initData: function () {
				//this.chosen = this.droppointData.chosen;
				this.droppointId = this.droppointData.droppointId || "";
				if (typeof (this.droppointData.chosen) === "undefined") {
					this.droppointChosen = false;
				}
				if (this.droppointData.collectionSlots) { // && this.droppointData.collectionSlots) {
					this.droppointData.distanceInKm = (Math.round(this.droppointData.DistanceInMeters / 100)) / 10;

					var dayCount = 0;
					var self = this;
					this.droppointData.weekCollectionSlots = [];
					if (!this.droppointData.collectionSlots) this.droppointData.collectionSlots = [];

					this.droppointData.collectionSlots.forEach(function (collectionSlot) {
						dayCount++;
						if (dayCount <= 7) {

							collectionSlot.collectionDateTime = self._getUtcTime(new Date(collectionSlot.collectionDate));
							collectionSlot.day = DOW_NAMES[collectionSlot.collectionDateTime.getDay()];

							collectionSlot.timeSlots.forEach(function (timeSlot) {
								timeSlot.fromDateTime = self._getUtcTime(new Date(timeSlot.from));
								timeSlot.toDateTime = self._getUtcTime(new Date(timeSlot.to));
								timeSlot.fromTime = self._getTimeStr(timeSlot.fromDateTime);
								timeSlot.toTime = self._getTimeStr(timeSlot.toDateTime);
							});
							if (collectionSlot.timeSlots.length > 0) {
								self.droppointData.weekCollectionSlots.push(collectionSlot);
							}
						}
					});

					this.streetAddress = this.droppointData.geoLocation.addressLines[0] + ", " + this.droppointData.geoLocation.town + ", " + this.droppointData.geoLocation.postCode
				}
			},


			//Global event handler
			onDroppointChanged: function (e) {
				this.set("droppointData", e.detail);
				this._visible = this.droppointData.chosen;
				// this.droppointData = e.detail.droppointData;
				this.render();
			},

			render: function () {
				this.initData();
				if (this.droppointData.chosen) {
					this.buttonClass = "chosen";
					this.buttonText = "Chosen";
				}
				else {
					this.buttonClass = "unchosen";
					this.buttonText = "Choose";
				}
			},

			// toggleChooseDropPoint: function () {
			// 	this.set("droppointData.chosen", !this.droppointData.chosen);
			// 	this.chosenChanged();
			// },

			_getUtcTime: function (d) {
				var utc = new Date(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate(), d.getUTCHours(), d.getUTCMinutes(), d.getUTCSeconds());
				return utc;
			},

			_getTimeStr: function (d) {
				var minutes = d.getMinutes().toString().length == 1 ? '0' + d.getMinutes() : d.getMinutes();
				var hours = (d.getHours() % 12).toString();
				var ampm = d.getHours() >= 12 ? 'pm' : 'am';
				return hours + ':' + minutes + ampm;
			},

			_listenForChoose: function (e) {
			}

		});
	</script>
</dom-module>
